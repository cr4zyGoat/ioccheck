package ticlients

import (
	"encoding/json"
	"io"
	"log"
	"net/http"
	"net/url"
)

const (
	malwareBazaarBaseUrl string = "https://mb-api.abuse.ch/api/v1"
)

type MalwareBazaarClient struct {
	threads chan bool
}

type malwareBazaarResponse struct {
	QueryStatus string `json:"query_status"`
	Data        []struct {
		SHA256       string   `json:"sha256_hash"`
		SHA1         string   `json:"sha1_hash"`
		MD5          string   `json:"md5_hash"`
		Filename     string   `json:"file_name"`
		FileTypeMime string   `json:"file_type_mime"`
		FileSize     int      `json:"file_size"`
		Tags         []string `json:"tags"`
	} `json:"data"`
}

func NewMalwareBazaarClient(threads int) *MalwareBazaarClient {
	client := new(MalwareBazaarClient)
	client.threads = make(chan bool, threads)
	return client
}

func (client *MalwareBazaarClient) CheckHash(ioc string) bool {
	params := url.Values{}
	params.Add("query", "get_info")
	params.Add("hash", ioc)

	client.threads <- true
	res, err := http.PostForm(malwareBazaarBaseUrl, params)
	<-client.threads

	if err != nil {
		log.Println(err)
		return false
	}

	defer res.Body.Close()
	var response malwareBazaarResponse
	body, _ := io.ReadAll(res.Body)
	err = json.Unmarshal(body, &response)
	if err != nil {
		log.Println(err)
		return false
	}

	if response.QueryStatus == "ok" {
		return true
	}

	return false
}
