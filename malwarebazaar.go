package main

import (
	"encoding/json"
	"io"
	"log"
	"net/http"
	"net/url"
)

const (
	MalwareBazaarBaseUrl string = "https://mb-api.abuse.ch/api/v1"
)

type MalwareBazaarResponse struct {
	QueryStatus string `json:"query_status"`
	Data        []struct {
		SHA256       string   `json:"sha256_hash"`
		SHA1         string   `json:"sha1_hash"`
		MD5          string   `json:"md5_hash"`
		Filename     string   `json:"file_name"`
		FileTypeMime string   `json:"file_type_mime"`
		FileSize     int      `json:"file_size"`
		Tags         []string `json:"tags"`
	} `json:"data"`
}

type MalwareBazaarClient struct{}

func (client *MalwareBazaarClient) CheckIOC(ioc IOC) bool {
	params := url.Values{}
	params.Add("query", "get_info")
	params.Add("hash", string(ioc))

	res, err := http.PostForm(MalwareBazaarBaseUrl, params)
	if err != nil {
		log.Println(err)
		return false
	}
	defer res.Body.Close()

	var response MalwareBazaarResponse
	body, _ := io.ReadAll(res.Body)
	err = json.Unmarshal(body, &response)
	if err != nil {
		log.Println(err)
		return false
	}

	if response.QueryStatus == "ok" {
		return true
	}

	return false
}
